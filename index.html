<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Pro - Master Stable</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏Å‡∏±‡∏ô‡∏Ç‡∏≤‡∏ß‡πÇ‡∏û‡∏•‡∏ô */
        #map { height: 100vh; width: 100%; background: #e9ecef; position: absolute; top: 0; left: 0; z-index: 1; }
        body { margin: 0; padding: 0; font-family: 'Kanit', sans-serif; overflow: hidden; }
        
        .ui-panel { 
            position: absolute; top: 10px; right: 10px; z-index: 1000; 
            background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 260px; max-height: 90vh; overflow-y: auto; 
        }
        button { width: 100%; padding: 10px; margin-top: 8px; cursor: pointer; border: none; border-radius: 6px; color: white; font-weight: bold; transition: 0.3s; }
        input { width: 85%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; }
        .btn-blue { background-color: #0d6efd; }
        .btn-green { background-color: #198754; }
        .btn-red { background-color: #dc3545; }
        .btn-dark { background-color: #212529; }
        .config-box { background: #f1f3f5; padding: 12px; border-radius: 8px; margin-top: 10px; border: 1px solid #dee2e6; }
        .status-text { font-size: 0.9em; margin-bottom: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="ui-panel">
        <div class="status-text">‡∏ö‡∏≠‡∏£‡πå‡∏î: <span id="status" style="color: gray;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</span></div>
        <small id="time">-</small>
        <hr>
        
        <div class="config-box">
            <b>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï (Geofence)</b><br>
            <label><small>‡∏£‡∏±‡∏®‡∏°‡∏µ (‡πÄ‡∏°‡∏ï‡∏£):</small></label>
            <input type="number" id="inputRadius" value="500">
            <p style="font-size: 0.8em; margin: 5px 0;">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡∏±‡πâ‡∏ß: <span id="displayCenter">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span></p>
            <button class="btn-dark" id="btnToggleMode">üîì ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏¥‡πâ‡∏°‡∏ß‡∏≤‡∏á‡∏£‡∏±‡πâ‡∏ß</button>
            <button class="btn-green" id="btnSaveFence">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï</button>
        </div>

        <button class="btn-blue" id="btnShowHistory">üö© ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</button>
        <button class="btn-red" id="btnDeleteDB">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <div id="map"></div>

    <script>
        // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏≠ Firebase ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏≤‡∏ß)
        var map = L.map('map').setView([14.9874, 102.1180], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        var marker = L.marker([14.9874, 102.1180]).addTo(map);
        var polyline = L.polyline([], {color: 'red', weight: 4}).addTo(map);
        var fenceCircle = L.circle([0, 0], {radius: 0, color: 'blue', fillOpacity: 0.1}).addTo(map);

        // 2. Config Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA5PIqr8Ss64jcwjWEDSAl0l7huc3yjYtM",
            databaseURL: "https://my-gps-tracker-2113a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "my-gps-tracker-2113a"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentFence = { lat: 14.9874, lng: 102.1180, radius: 500 };
        let isConfigMode = false;
        let lastHeartbeat = 0;

        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Geofence ‡∏à‡∏≤‡∏Å Firebase
        database.ref('Settings/Geofence').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                currentFence = data;
                fenceCircle.setLatLng([data.lat, data.lng]);
                fenceCircle.setRadius(data.radius);
                document.getElementById('inputRadius').value = data.radius;
                document.getElementById('displayCenter').innerText = data.lat.toFixed(4) + ", " + data.lng.toFixed(4);
            }
        });

        // ‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏¥‡πâ‡∏°‡∏ß‡∏≤‡∏á‡∏£‡∏±‡πâ‡∏ß
        document.getElementById('btnToggleMode').onclick = function() {
            isConfigMode = !isConfigMode;
            this.innerText = isConfigMode ? "üîí ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏¥‡πâ‡∏° (Lock)" : "üîì ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏¥‡πâ‡∏°‡∏ß‡∏≤‡∏á‡∏£‡∏±‡πâ‡∏ß";
            this.style.backgroundColor = isConfigMode ? "#ffc107" : "#212529";
            this.style.color = isConfigMode ? "black" : "white";
        };

        map.on('click', function(e) {
            if (isConfigMode) {
                currentFence.lat = e.latlng.lat;
                currentFence.lng = e.latlng.lng;
                fenceCircle.setLatLng([e.latlng.lat, e.latlng.lng]);
                document.getElementById('displayCenter').innerText = e.latlng.lat.toFixed(4) + ", " + e.latlng.lng.toFixed(4);
            }
        });

        document.getElementById('btnSaveFence').onclick = function() {
            currentFence.radius = parseInt(document.getElementById('inputRadius').value);
            database.ref('Settings/Geofence').set(currentFence).then(() => {
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                isConfigMode = false;
                document.getElementById('btnToggleMode').innerText = "üîì ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏¥‡πâ‡∏°‡∏ß‡∏≤‡∏á‡∏£‡∏±‡πâ‡∏ß";
                document.getElementById('btnToggleMode').style.backgroundColor = "#212529";
                document.getElementById('btnToggleMode').style.color = "white";
            });
        };

        // ‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
        database.ref('GPS').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data && data.lat) {
                const pos = [data.lat, data.lng];
                marker.setLatLng(pos);
                if (!isConfigMode) map.panTo(pos);

                const dist = L.latLng(pos).distanceTo(L.latLng([currentFence.lat, currentFence.lng]));
                if (dist > currentFence.radius) {
                    document.getElementById('status').innerText = "ALARM: ‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï! (" + Math.round(dist) + "‡∏°.)";
                    document.getElementById('status').style.color = "red";
                    fenceCircle.setStyle({color: 'red', fillColor: '#f03'});
                } else {
                    document.getElementById('status').innerText = "Online - ‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï";
                    document.getElementById('status').style.color = "green";
                    fenceCircle.setStyle({color: 'blue', fillColor: '#30f'});
                }
                lastHeartbeat = Date.now();
                document.getElementById('time').innerText = "‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + new Date().toLocaleTimeString();
            }
        });

        // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
        document.getElementById('btnShowHistory').onclick = function() {
            database.ref('History').limitToLast(200).once('value', (s) => {
                let p = [];
                s.forEach(c => { if(c.val().lat) p.push([c.val().lat, c.val().lng]); });
                if (p.length > 0) {
                    polyline.setLatLngs(p);
                    map.fitBounds(polyline.getBounds());
                } else { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á"); }
            });
        };

        // ‡∏•‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        document.getElementById('btnDeleteDB').onclick = function() {
            if (confirm("‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ñ‡∏≤‡∏ß‡∏£?")) {
                database.ref('History').remove();
                polyline.setLatLngs([]);
                alert("‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            }
        };

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Offline
        setInterval(() => {
            if (lastHeartbeat > 0 && (Date.now() - lastHeartbeat > 20000)) {
                document.getElementById('status').innerText = "Offline - ‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠";
                document.getElementById('status').style.color = "orange";
            }
        }, 5000);
    </script>
</body>
</html>